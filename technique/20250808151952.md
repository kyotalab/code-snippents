---
id: 20250808151952
title: Go CLI開発 - Cobra実装
type: technique
tags:
  [
    go,
    cli,
    cobra,
    struct,
    global-state,
    pointer-receiver,
    error-handling,
    cobra-cli,
  ]
created: 2025-08-08 15:19:52
updated: 2025-08-08 15:19:52
---

## Go CLI開発 - Cobra実装

### プロジェクト初期化

```bash
mkdir -p project
go mod init kyotalab/project
cobra-cli init
```

---

### 実装のポイント

#### 構造体設計

- `Config`構造体でコマンドライン設定を管理（`args`はcobra予約済みのため回避）
- パッケージレベルの`var config Config`でグローバル状態管理

#### Cobraコマンド設定

- `cobra.Command`構造体でコマンド定義
- `Args: cobra.MaximumNArgs(1)`で引数の個数制限
- `Run`フィールドで実際の処理ロジックを定義

#### フラグ登録

- `rootCmd.Flags().BoolVarP()`でブールフラグと構造体フィールドを直接バインド
- 第3引数でデフォルト値、第4引数でヘルプメッセージを設定
- ショートオプション（`-c`）とロングオプション（`--bytes`）の同時定義

#### 引数処理

- `Run`関数内の`args []string`で位置引数を処理
- `len(args) > 0`チェックでオプショナルな引数を安全に扱う

#### メソッド定義

- レシーバーメソッド`(c *Config)`でポインタレシーバーを使用
- `hasAnyFlags()`でフラグ存在チェック
- `withDefaults()`でデフォルト値設定（副作用あり）

#### Goらしい設計パターン

- パッケージレベルの`Execute()`関数でエラーハンドリング
- `init()`関数でフラグの初期化処理
- エラー時の`os.Exit(1)`による適切な終了コード設定

#### 注意点

- グローバル変数`config`への依存
- ポインタレシーバーによる副作用のある状態変更

---

### 実装コード

**cmd/root.go**

```go
/*
Copyright © 2025 NAME HERE <EMAIL ADDRESS>
*/
package cmd

import (
	"fmt"
	"os"

	"github.com/spf13/cobra"
)

type Config struct {
	Bytes         bool
	Lines         bool
	Chars         bool
	Words         bool
	MaxLineLength bool
	FilePath      string
}

func (c *Config) hasAnyFlags() bool {
	return c.Bytes || c.Lines || c.Chars || c.Words || c.MaxLineLength
}

func (c *Config) withDefaults() {
	if !c.hasAnyFlags() {
		c.Bytes = true
		c.Lines = true
		c.Words = true
	}
}

var config Config

var rootCmd = &cobra.Command{
	Use:   "wc-go",
	Short: "A brief description of your application",
	Long: `A longer description that spans multiple lines and likely contains
examples and usage of using your application. For example:

Cobra is a CLI library for Go that empowers applications.
This application is a tool to generate the needed files
to quickly create a Cobra application.`,
	Args: cobra.MaximumNArgs(1),
	Run: func(cmd *cobra.Command, args []string) {
		if len(args) > 0 {
			config.FilePath = args[0]
		}

		config.withDefaults()

		fmt.Printf("%v\n", config.FilePath)
		fmt.Printf("%v\n", config.Bytes)
		fmt.Printf("%v\n", config.Lines)
		fmt.Printf("%v\n", config.Chars)
		fmt.Printf("%v\n", config.Words)
		fmt.Printf("%v\n", config.MaxLineLength)
	},
}

////////////// Base commands //////////////

func Execute() {
	err := rootCmd.Execute()
	if err != nil {
		os.Exit(1)
	}
}

func init() {
	rootCmd.Flags().BoolP("toggle", "t", false, "Help message for toggle")
	rootCmd.Flags().BoolVarP(&config.Bytes, "bytes", "c", false, "")
	rootCmd.Flags().BoolVarP(&config.Lines, "lines", "l", false, "")
	rootCmd.Flags().BoolVarP(&config.Chars, "chars", "m", false, "")
	rootCmd.Flags().BoolVarP(&config.Words, "words", "w", false, "")
	rootCmd.Flags().BoolVarP(&config.MaxLineLength, "max-line-length", "L", false, "")
}

```
