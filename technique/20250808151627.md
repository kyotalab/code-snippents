---
id: 20250808151627
title: Rust CLI開発 - clapクレート実装
type: technique
tags:
  [
    rust,
    cli,
    clap,
    derive-macro,
    type-safety,
    builder-pattern,
    ownership,
    cargo,
  ]
created: 2025-08-08 15:16:27
updated: 2025-08-08 15:19:45
---

## Rust CLI開発 - clapクレート実装

### プロジェクト初期化

```bash
cargo new project
cargo add clap --features derive
```

---

### 実装のポイント

#### 構造体設計

- `#[derive(Debug, Parser)]`でclapの派生マクロを活用
- `Args`構造体にすべてのコマンドライン引数を集約
- `Option<PathBuf>`でファイルパスのオプショナル引数を型安全に扱う

#### 引数グループ化

- `ArgGroup::new("output").multiple(true)`で相互排他でない出力オプショングループを定義
- 各フラグに`group = "output"`を指定してグループに所属させる

#### フラグ定義の特徴

- `#[arg(short = 'c', long, group = "output")]`でショートオプションとロングオプションを同時定義
- `short`、`long`属性で直感的なオプション名を設定

#### カスタムメソッド実装

- `has_any_flags()`でフラグの存在チェック
- `with_defaults()`でデフォルト値の設定（Builder パターン風）
- メソッドチェーンで`Args::parse().with_defaults()`として利用

#### 型安全性の活用

- `PathBuf`型でファイルパス操作の型安全性を確保
- `bool`型でフラグの状態管理をシンプルに

#### Rustらしい設計

- 所有権システムを活用した`mut self`によるself消費パターン
- `impl`ブロックで構造体にメソッドを追加する慣用的な手法

---

### 実装コード

**arg.rs**

```rust
use std::path::PathBuf;

use clap::{ArgGroup, Parser};

#[derive(Debug, Parser)]
#[command(group = ArgGroup::new("output").multiple(true))]
pub struct Args {
    #[arg(short = 'c', long, group = "output")]
    pub bytes: bool,

    #[arg(short, long, group = "output")]
    pub lines: bool,

    #[arg(short = 'm', long, group = "output")]
    pub chars: bool,

    #[arg(short, long, group = "output")]
    pub words: bool,

    #[arg(short = 'L', long = "max-line-length", group = "output")]
    pub max_line_length: bool,

    #[arg(help = "file path")]
    pub file_path: Option<PathBuf>,
}

impl Args {
    pub fn has_any_flags(&self) -> bool {
        self.bytes || self.lines || self.chars || self.words || self.max_line_length
    }

    pub fn with_defaults(mut self) -> Self {
        if !self.has_any_flags() {
            self.bytes = true;
            self.lines = true;
            self.words = true;
        }
        self
    }
}
```

**main.rs**

```rust
use clap::Parser;
use wc_rs::Args;

fn main() {
    let args = Args::parse().with_defaults();
    println!("{:?}", args);
}
```
