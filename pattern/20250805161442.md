---
id: 20250805161442
title: Rust エラーファーストドメイン設計におけるエラー定義基本セット
type: pattern
tags: [rust, error-first-design, cli]
created: 2025-08-05 16:14:42
updated: 2025-08-05 16:28:11
---

## Rust エラーファーストドメイン設計におけるエラー定義基本セット

### 1. CLIツール用エラー定義

```rust
use std::path::PathBuf;
use thiserror::Error;

// =============================================================================
// 1. CLIツール用エラー定義（シンプル版）
// =============================================================================

/// CLIアプリケーションの統合エラー型
#[derive(Error, Debug)]
pub enum AppError {
    // --- ユーザー入力関連エラー ---
    /// 無効な引数やオプション
    #[error("Invalid argument: {message}")]
    InvalidArgument { message: String },

    /// 必須引数の不足
    #[error("Missing required argument: {argument}")]
    MissingArgument { argument: String },

    /// 無効なファイルパス
    #[error("Invalid file path: {path}")]
    InvalidPath { path: PathBuf },

    // --- ファイル操作エラー ---
    /// ファイルが見つからない
    #[error("File not found: {path}")]
    FileNotFound { path: PathBuf },

    /// ファイル読み書きエラー
    #[error("File I/O error: {path} - {message}")]
    FileIo { path: PathBuf, message: String },

    /// ファイル形式エラー
    #[error("Invalid file format: {path} - expected {expected}, got {actual}")]
    InvalidFileFormat {
        path: PathBuf,
        expected: String,
        actual: String,
    },

    // --- データ処理エラー ---
    /// JSON解析エラー
    #[error("JSON parse error in {file}: {message}")]
    JsonParse { file: String, message: String },

    /// YAML解析エラー
    #[error("YAML parse error in {file}: {message}")]
    YamlParse { file: String, message: String },

    /// CSV解析エラー
    #[error("CSV parse error in {file}: {message}")]
    CsvParse { file: String, message: String },

    // --- 設定・環境エラー ---
    /// 設定ファイルエラー
    #[error("Configuration error: {message}")]
    Config { message: String },

    /// 環境変数エラー
    #[error("Environment variable error: {variable} - {message}")]
    Environment { variable: String, message: String },

    // --- ネットワーク・外部サービスエラー ---
    /// ネットワーク接続エラー
    #[error("Network error: {message}")]
    Network { message: String },

    /// API呼び出しエラー
    #[error("API error: {endpoint} returned {status} - {message}")]
    Api {
        endpoint: String,
        status: u16,
        message: String,
    },

    // --- 汎用エラー ---
    /// 想定外の内部エラー
    #[error("Internal error: {message}")]
    Internal { message: String },

    /// 機能未実装（開発中）
    #[error("Feature not implemented: {feature}")]
    NotImplemented { feature: String },
}
```

---

### 2. コンストラクタ関数

```rust
// =============================================================================
// 2. 便利なコンストラクタ関数
// =============================================================================

impl AppError {
    // --- ユーザー入力エラー ---
    pub fn invalid_argument(message: impl Into<String>) -> Self {
        Self::InvalidArgument {
            message: message.into(),
        }
    }

    pub fn missing_argument(argument: impl Into<String>) -> Self {
        Self::MissingArgument {
            argument: argument.into(),
        }
    }

    pub fn invalid_path(path: impl Into<PathBuf>) -> Self {
        Self::InvalidPath { path: path.into() }
    }

    // --- ファイル操作エラー ---
    pub fn file_not_found(path: impl Into<PathBuf>) -> Self {
        Self::FileNotFound { path: path.into() }
    }

    pub fn file_io(path: impl Into<PathBuf>, message: impl Into<String>) -> Self {
        Self::FileIo {
            path: path.into(),
            message: message.into(),
        }
    }

    pub fn invalid_file_format(
        path: impl Into<PathBuf>,
        expected: impl Into<String>,
        actual: impl Into<String>,
    ) -> Self {
        Self::InvalidFileFormat {
            path: path.into(),
            expected: expected.into(),
            actual: actual.into(),
        }
    }

    // --- データ処理エラー ---
    pub fn json_parse(file: impl Into<String>, message: impl Into<String>) -> Self {
        Self::JsonParse {
            file: file.into(),
            message: message.into(),
        }
    }

    pub fn yaml_parse(file: impl Into<String>, message: impl Into<String>) -> Self {
        Self::YamlParse {
            file: file.into(),
            message: message.into(),
        }
    }

    pub fn csv_parse(file: impl Into<String>, message: impl Into<String>) -> Self {
        Self::CsvParse {
            file: file.into(),
            message: message.into(),
        }
    }

    // --- 設定・環境エラー ---
    pub fn config(message: impl Into<String>) -> Self {
        Self::Config {
            message: message.into(),
        }
    }

    pub fn environment(variable: impl Into<String>, message: impl Into<String>) -> Self {
        Self::Environment {
            variable: variable.into(),
            message: message.into(),
        }
    }

    // --- ネットワーク・外部サービスエラー ---
    pub fn network(message: impl Into<String>) -> Self {
        Self::Network {
            message: message.into(),
        }
    }

    pub fn api(endpoint: impl Into<String>, status: u16, message: impl Into<String>) -> Self {
        Self::Api {
            endpoint: endpoint.into(),
            status,
            message: message.into(),
        }
    }

    // --- 汎用エラー ---
    pub fn internal(message: impl Into<String>) -> Self {
        Self::Internal {
            message: message.into(),
        }
    }

    pub fn not_implemented(feature: impl Into<String>) -> Self {
        Self::NotImplemented {
            feature: feature.into(),
        }
    }
}
```

---

### 3. 標準ライブラリエラーからの自動変換

```rust
// =============================================================================
// 3. 標準ライブラリエラーからの自動変換
// =============================================================================

impl From<std::io::Error> for AppError {
    fn from(error: std::io::Error) -> Self {
        match error.kind() {
            std::io::ErrorKind::NotFound => Self::file_not_found("unknown"),
            std::io::ErrorKind::PermissionDenied => Self::file_io("unknown", "Permission denied"),
            _ => Self::file_io("unknown", error.to_string()),
        }
    }
}

impl From<serde_json::Error> for AppError {
    fn from(error: serde_json::Error) -> Self {
        Self::json_parse("unknown", error.to_string())
    }
}

impl From<serde_yaml::Error> for AppError {
    fn from(error: serde_yaml::Error) -> Self {
        Self::yaml_parse("unknown", error.to_string())
    }
}

impl From<csv::Error> for AppError {
    fn from(error: csv::Error) -> Self {
        Self::csv_parse("unknown", error.to_string())
    }
}

// HTTP client libraries (reqwest, ureq等)
#[cfg(feature = "reqwest")]
impl From<reqwest::Error> for AppError {
    fn from(error: reqwest::Error) -> Self {
        if error.is_timeout() {
            Self::network("Request timeout")
        } else if error.is_connect() {
            Self::network("Connection failed")
        } else {
            Self::network(error.to_string())
        }
    }
}
```

---

### 4. CLI向けユーティリティ（exit_code, user_message等）

```rust
// =============================================================================
// 4. CLIフレンドリーな機能
// =============================================================================

impl AppError {
    /// ユーザーにとって分かりやすいエラーメッセージを生成
    pub fn user_message(&self) -> String {
        match self {
            Self::InvalidArgument { .. } => {
                format!("{}\nUse --help for usage information.", self)
            }
            Self::MissingArgument { .. } => {
                format!("{}\nUse --help for usage information.", self)
            }
            Self::FileNotFound { .. } => {
                format!("{}\nPlease check the file path and try again.", self)
            }
            Self::Config { .. } => {
                format!("{}\nPlease check your configuration file.", self)
            }
            Self::Network { .. } => {
                format!("{}\nPlease check your internet connection.", self)
            }
            _ => self.to_string(),
        }
    }

    /// エラーの終了コードを返す
    pub fn exit_code(&self) -> i32 {
        match self {
            Self::InvalidArgument { .. } => 1,
            Self::MissingArgument { .. } => 1,
            Self::InvalidPath { .. } => 1,
            Self::FileNotFound { .. } => 2,
            Self::FileIo { .. } => 2,
            Self::InvalidFileFormat { .. } => 2,
            Self::JsonParse { .. } => 3,
            Self::YamlParse { .. } => 3,
            Self::CsvParse { .. } => 3,
            Self::Config { .. } => 4,
            Self::Environment { .. } => 4,
            Self::Network { .. } => 5,
            Self::Api { .. } => 5,
            Self::Internal { .. } => 99,
            Self::NotImplemented { .. } => 99,
        }
    }

    /// エラーが回復可能かどうか
    pub fn is_recoverable(&self) -> bool {
        matches!(self, Self::Network { .. } | Self::Api { .. })
    }

    /// ヘルプメッセージを表示すべきかどうか
    pub fn should_show_help(&self) -> bool {
        matches!(
            self,
            Self::InvalidArgument { .. } | Self::MissingArgument { .. }
        )
    }
}
```

---

### 5. Result型エイリアス

```rust
// =============================================================================
// 5. Result型エイリアス
// =============================================================================

/// CLIアプリケーション用のResult型
pub type AppResult<T> = Result<T, AppError>;
```

---

### 6. エラーハンドリングヘルパー

```rust
// =============================================================================
// 6. エラーハンドリングヘルパー
// =============================================================================

/// CLIアプリケーションでの標準的なエラーハンドリング
pub fn handle_error(error: AppError) -> ! {
    eprintln!("Error: {}", error.user_message());

    if error.should_show_help() {
        eprintln!("\nFor more information, run with --help");
    }

    std::process::exit(error.exit_code());
}

/// メイン関数での使用を想定したヘルパーマクロ
#[macro_export]
macro_rules! cli_main {
    ($main_func:expr) => {
        fn main() {
            if let Err(error) = $main_func() {
                handle_error(error);
            }
        }
    };
}
```

---

### 7. ファイル操作ヘルパー

```rust
// =============================================================================
// 7. 実用的なファイル操作ヘルパー
// =============================================================================

/// ファイル読み込みの安全なラッパー
pub fn read_file(path: impl Into<PathBuf>) -> AppResult<String> {
    let path = path.into();

    if !path.exists() {
        return Err(AppError::file_not_found(&path));
    }

    std::fs::read_to_string(&path).map_err(|e| AppError::file_io(&path, e.to_string()))
}

/// ファイル書き込みの安全なラッパー
pub fn write_file(path: impl Into<PathBuf>, content: &str) -> AppResult<()> {
    let path = path.into();

    // 親ディレクトリが存在しない場合は作成
    if let Some(parent) = path.parent() {
        if !parent.exists() {
            std::fs::create_dir_all(parent)
                .map_err(|e| AppError::file_io(parent, e.to_string()))?;
        }
    }

    std::fs::write(&path, content).map_err(|e| AppError::file_io(&path, e.to_string()))
}

/// JSONファイルの読み込み
pub fn read_json_file<T>(path: impl Into<PathBuf>) -> AppResult<T>
where
    T: serde::de::DeserializeOwned,
{
    let path = path.into();
    let content = read_file(&path)?;

    serde_json::from_str(&content)
        .map_err(|e| AppError::json_parse(path.display().to_string(), e.to_string()))
}

/// JSONファイルの書き込み
pub fn write_json_file<T>(path: impl Into<PathBuf>, data: &T) -> AppResult<()>
where
    T: serde::Serialize,
{
    let path = path.into();
    let content = serde_json::to_string_pretty(data)
        .map_err(|e| AppError::json_parse(path.display().to_string(), e.to_string()))?;

    write_file(path, &content)
}
```

---

### Dependencies

```toml
[dependencies]
thiserror = "1.0"
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"

# オプション機能
clap = { version = "4.0", optional = true }
serde_yaml = { version = "0.9", optional = true }
csv = { version = "1.2", optional = true }
reqwest = { version = "0.11", features = ["json"], optional = true }
tracing = { version = "0.1", optional = true }
tracing-subscriber = { version = "0.3", optional = true }
indicatif = { version = "0.17", optional = true }

[dev-dependencies]
tempfile = "3.0"

[features]
default = ["clap"]
full = ["clap", "serde_yaml", "csv", "reqwest", "tracing", "indicatif"]
cli = ["clap"]
formats = ["serde_yaml", "csv"]
http = ["reqwest"]
logging = ["tracing", "tracing-subscriber"]
progress = ["indicatif"]
```

---

### Related Notes

- [Rust エラーファーストドメイン設計におけるエラー定義Clap統合セット](../pattern/20250805161920.md)
- [rust-cli-error-design.rs](./rust-cli-error-design.rs)
