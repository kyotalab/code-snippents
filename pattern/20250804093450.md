---
id: 20250804093450
title: Rust ファイル読み込みミニマム実装
type: pattern
tags: [rust, file-io, cli, buffered-reader, error-handling, template]
created: 2025-08-04 09:34:50
updated: 2025-08-04 14:21:33
---

## Rust ファイル読み込みミニマム実装

### Snippet Code 1

- 設定ファイル読み込み（通常数KB〜数MB）
- テキスト全体の解析が必要
- プロトタイプや学習目的
- ファイルサイズが予測可能で小さい

```rust
use std::{
    io::{
        self, Read
    }
};
use anyhow::{Context, Result};
use clap::Parser;

fn main() -> Result<()>{
    let args = Args::parse();
    let content = if let Some(path) = args.file_path {
        std::fs::read_to_string(&path)
            .with_context(|| format!("Failed to open file: {}", &path))?
    } else {
        let mut buffer = String::new();
        io::stdin().read_to_string(&mut buffer)
            .with_context(|| format!("Failed to read from stdin"))?;
        buffer
    };

    println!("{}", content);

    Ok(())
}

#[derive(Debug, Parser)]
pub struct Args {
    /// Path to the input file (reads from stdin if not provided)
    pub file_path: Option<String>,
}
```

### Snippet Code 2

- ログファイル処理
- 大容量データの処理
- ストリーミング処理が必要
- メモリ使用量を抑えたい場合

```rust
use std::{
    fs::File,
    io::{
        self, BufRead, BufReader
    }
};
use anyhow::{Context, Result};
use clap::Parser;

fn main() -> Result<()>{
    let args = Args::parse();
    let reader: Box<dyn BufRead> = if let Some(path) = &args.file_path {
        let file = File::open(path)
            .with_context(|| format!("Failed to open file: {}", path))?;
        Box::new(BufReader::new(file))
    } else {
        Box::new(BufReader::new(io::stdin()))
    };

    for line in reader.lines() {
        let line = line.with_context(|| "Failed to read line")?;
        println!("{}", line);
    }
    Ok(())
}

#[derive(Debug, Parser)]
pub struct Args {
    /// Path to the input file (reads from stdin if not provided)
    pub file_path: Option<String>,
}
```

---

### Points

1. **エラーコンテキスト**: `with_context()` でより詳細なエラーメッセージを提供
2. **借用の最適化**: `&args.file_path` で不要なクローンを回避
3. **ドキュメンテーション**: clapの `///` コメントでヘルプメッセージを追加
4. **文字列フォーマット**: `println!("{line}")` よりも、 `println!("{}", line)` でより明示的にする

---

### Dependencies

2025-08-04（現在）

```toml
[dependencies]
anyhow = "1.0.98"
clap = { version = "4.5.42", features = ["derive"] }
```
